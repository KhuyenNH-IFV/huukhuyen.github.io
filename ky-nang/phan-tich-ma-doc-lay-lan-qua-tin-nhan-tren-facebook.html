<!DOCTYPE html><title>Kỹ năng</title><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><base href=https://huukhuyen.github.io/ ><link href=logo.ico rel=icon type=image/x-icon><!--[if lte IE 8]><script src=../assets/js/ie/html5shiv.js></script><![endif]--><link href=../assets/css/flatWeatherPlugin.css rel=stylesheet><link href=../assets/css/share.css rel=stylesheet><link href=../assets/css/main.css rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Noto+Serif%3Aregular&subset=vietnamese&ver=4.8"rel=stylesheet><!--[if lte IE 9]><link href=../assets/css/ie9.css rel=stylesheet><![endif]--><!--[if lte IE 8]><link href=../assets/css/ie8.css rel=stylesheet><![endif]--><body onload=startWeather()><div id=banner_block></div><div id=wrapper><header id=header><h1><a href=/ >Trang chủ</a></h1><nav class=links><ul><li><a href=cv/ >Giới thiệu</a><li><a href=chuyen-cuoc-song/ >Chuyện cuộc sống</a><li><a href=chuyen-nghe-nghiep/ >Chuyện nghề nghiệp</a><li><a href=ky-nang/ >Kỹ năng</a></ul></nav><nav class=main><ul><li class=search><a href=#search class=fa-search>Search</a><form action=# id=search><input name=query placeholder=Search></form><li class=menu><a href=#menu class=fa-bars>Menu</a></ul></nav></header><section id=menu><section><form action=# class=search><input name=query placeholder=Search></form></section><section><ul class=links><li><h4><a href=cv/ >Lý lịch cá nhân</a><li><h4><a href=chuyen-cuoc-song/ >Chuyện cuộc sống</a><li><h4><a href=chuyen-nghe-nghiep/ >Chuyện nghề nghiệp</a><li><h4><a href=ky-nang/ >Kỹ năng</a></ul></section><section class=weather><p id=weatherDanang></section></section><div id=main><nav><ul class=breadcrumb><li><a href="">Trang chủ</a><li><a href=ky-nang/ >Kỹ năng</a></ul></nav><article class="fadeTop post"><header><div class="title titlePost"><h2>Phân tích mã độc lây lan qua tin nhắn trên Facebook (11/2016)</h2><p class=timePost>Posted by KhuyenNguyen on December 21, 2016</div></header><div class=description-post><p>Phân tích mã độc Facebook lây lan qua tin nhắn và hướng dẫn cách ngăn chặn mã độc Facebook tự động gửi tin nhắn cho toàn bộ bạn bè.<h2>Phân tích mã độc trên Facebook (11/2016)</h2><p>Có 2 biến thể của con malware này, một con thì gửi tập tin HTML và một thì gửi tập tin SVG. Điểm chung là cả 2 định dạng này đều có thể thực thi JavaScript (mấu chốt của con malware này). HTML thì không có gì để nói; còn SVG – nếu bạn nào không phải dân lập trình web thì có lẽ không biết rằng nó cũng có thể nhúng JavaScript mặc dù nó là định dạng đồ họa vector.<p>Nếu bạn có lỡ click và tải tập tin đính kèm được gửi qua tin nhắn Facebook thì đừng lo, tại thời điểm này bạn vẫn an toàn. Nhưng sau khi bạn vô tình mở tập tin đó, đoạn JavaScript được nhúng trong các tập tin sẽ được thực thi. Chuyện gì sẽ xảy ra? Chúng ta hãy cùng phân tích đoạn mã nhúng đó!</p><img alt=""src=images/kn/kn_01.png><p>Đoạn mã trên sẽ chuyển hướng người dùng tới trang web có địa chỉ: <i>mourid[dot]com/php/trust.php</i><p>Và được chuyển hướng tiếp đến trang: <i>kerman[dot]pw/?fb_dsa</i><p>Trang vừa load xong, tôi còn chưa kịp nhìn thấy gì thì cái giao diện màu đỏ quen thuộc hiện lên…</p><img alt=""src=images/kn/kn_01_02.png><p>Chú ý là tại thời điểm viết bài này thì trang web đó chưa được tôi cho vào Cơ sở dữ liệu của J2TeaM Security, quyết định chặn trang web được đưa ra dựa trên việc phân tích mã nguồn trang theo thời gian thực.<p>Để tiếp tục phục vụ anh em, tôi đành ngậm ngùi tắt chế độ bảo vệ thời gian thực của <a href=https://junookyo.blogspot.com/2016/10/j2team-security-chrome-extension.html>J2TeaM Security</a> và nhấn F5<p>Trang thứ 2 này có giao diện giả mạo Youtube. Chỉ cần nhấn nút Play video là một popup hiện lên yêu cầu bạn cài đặt một extension với tên gọi: <b>One</b><p>Trang vừa load xong, tôi còn chưa kịp nhìn thấy gì thì cái giao diện màu đỏ quen thuộc hiện lên…</p><img alt=""src=images/kn/kn_01_03.png><p>Theo thông tin từ Chrome Store thì extension này được cập nhật lần cuối vào ngày <b>19/11/2016</b>, đúng tối hôm 19 thì tôi nhận được tin nhắn đầu tiên trên page hỏi về mã độc mới. Và bắt đầu từ ngày 20 thì các bài viết than vãn, cảnh báo mã độc lây lan qua tin nhắn xuất hiện rất nhiều trên News Feed.<p>Mà vụ giả mạo trang xem video rồi bắt cài đặt extension này nghe quen nhỉ?<p>Tôi tải mã nguồn của extension này về và mở lên bằng Sublime. Như mọi con malware JS khác, con malware này cũng show ra cả đống code xấu xí đã được làm rối (obfuscated) với mục đích làm nản lòng người xem.<p>Nhưng với kinh nghiệm chiến đấu với mấy mẫu tương tự lây lan qua tin nhắn, thay vì ngồi deobfuscate thì tôi cài luôn extension vào trình duyệt (tôi sử dụng Sandbox nhé, đề nghị độc giả không bắt chước cài theo), rồi mở DevTools với chế độ xem từ trang nền của extension (background.html) và chuyển qua thẻ Network rồi dùng bộ lọc Ajax thì tôi tóm được truy vấn tới liên kết: <i>http://cerawa[dot]pw/manalovuci/kojakumoda.bg</i><p>Khi truy cập bạn sẽ thấy trả về mã lỗi <b>404 Not Found</b>. Nhưng đừng để bị lừa, đó chỉ là những gì chúng ta thấy. Còn con malware khi tạo truy vấn sẽ nhận được đoạn mã JS như sau:</p><img alt=""src=images/kn/kn_01_04.png><p>Chú ý vào dòng 52, truy vấn tiếp theo sẽ được tạo ra tới liên kết sau: <i>http://cerawa[dot]pw/jiziratepujopo/ozopulohece.js</i></p><img alt=""src=images/kn/kn_01_05.png> <img alt=""src=images/kn/kn_01_06.png><p>Bóc lớp vỏ bọc đầu tiên bằng cách thay eval thành <code>console.log:</code></p><img alt=""src=images/kn/kn_01_07.png><p>Nhìn hại não vậy thôi chứ đây chỉ là hình thức nối chuỗi đơn giản. Thực hiện tiếp deobfuscate để bóc lớp vỏ tiếp theo, ta được:</p><img alt=""src=images/kn/kn_01_08.png><p>Dựa theo đoạn kiểm tra điều kiện: location.hostname.indexOf('facebook.com') >= 0 thì chúng ta có thể nhận thấy đoạn code JS này chỉ thực thi khi người dùng đang truy cập vào Facebook. Tôi liền nhấn F12 (DevTools) rồi mở tab Facebook, đăng nhập vào tài khoản thử nghiệm (Test User).<p>Ngay khi vừa nhấn Enter và trang vừa tải xong, tôi bỗng cảm thấy trình duyệt đơ vài giây. Theo dõi tab Network thì thấy các truy vấn sau được tạo bởi VM (extension được chạy ở ngữ cảnh tách biệt với các trang web):</p><img alt=""src=images/kn/kn_01_09.png><p>Dựa theo thứ tự các truy vấn, chúng ta có thể nhận thấy con malware đã thực hiện những hành động sau đối với nạn nhân (khi đã đăng nhập Facebook):<ol><li>Gửi truy vấn POST tới <i>https://www.facebook.com/v2.8/dialog/oauth/</i> để lấy Access Token.<li>Sử dụng Acccess Token tạo truy vấn GET tới <i>https://graph.facebook.com/</i> để lấy danh sách bạn bè và trạng thái online hiện tại của họ.<li>Tạo truy vấn GET tới <i>https://futunga[dot]com/php/html.php?ext=me</i> để lấy mã nguồn của tập tin đính kèm HTML hoặc SVG đã được nhúng JS bên trong. Bằng cách lấy nội dung đính kèm từ server thay vì đặt luôn trong extension thì kẻ tấn công có thể tùy biến mã độc JS bất cứ lúc nào.<li>Tạo truy vấn POST tới <i>https://upload.facebook.com/ajax/mercury/upload.php</i> để tải tập tin đính kèm lên server của Facebook. Lúc này Facebook sẽ trả về tham số <code>file_id</code><li>Tạo truy vấn POST tới <i>https://www.facebook.com/messaging/send/</i> để gửi tin nhắn cho bạn bè theo ID người dùng của họ đồng thời trỏ tham số đính kèm là <code>file_id</code> tới giá trị nhận được từ bước 4.<li>Tạo truy vấn GET tới <i>https://futunga[dot]com/php/sonuc.php</i> với chuỗi truy vấn (query string) là ID người dùng hiện tại, ID người vừa nhận tin nhắn. Chúng ta có thể thấy truy vấn cuối cùng này để thống kê số tin nhắn đã gửi và những ai đã nhận được.<li>Lặp lại bước 5 và 6 cho tới khi hết danh sách bạn bè của người dùng hiện tại.</ol><p>Ngoài ra, ở phía trang nền (background) thì extension này cũng tạo các truy vấn tới Google Analytics (để thống kê xem có bao nhiêu nạn nhân). Cộng thêm với những quyền hạn khai báo từ Manifest thì extension này hoàn toàn có thể chiếm phiên làm việc, chèn quảng cáo vào các trang web hoặc điều hướng người dùng tới trang bất kỳ để tăng traffic từ đó thu về lợi nhuận.<h2>Làm sao để ngăn chặn mã độc này?</h2><p>Dựa theo những thông tin mà tôi đã phân tích trong bài viết này, các bạn có 2 cách để ngăn chặn con malware đang tung hoành trên Facebook:<h2>1. Sử dụng tập tin HOSTS của Window</h2><p>Chúng ta có thể thấy là để có thể lây lan thành công thì con malware này cần tạo ra quá nhiều truy vấn, vậy nên từ phía người dùng thì các bạn có thể đánh chặn bằng cách thêm các dòng sau vào tập tin HOSTS:<pre>
						127.0.0.1 mourid.com
						127.0.0.1 kerman.pw
						127.0.0.1 cerawa.pw
						127.0.0.1 futunga.com
					</pre><p>Tuy nhiên, cách này mang tính chất thủ công và phải cập nhật thường xuyên vì kẻ tấn công có thể đăng ký tới 4 tên miền chỉ để phát tán 1 con malware thì tôi nghĩ hắn thừa sức đăng ký thêm nhiều hơn nữa. Vì vậy, các bạn có thể dùng cách thứ 2.<h2>2. Sử dụng J2TeaM Security (người tạo ra chính là tác giả bài phân tích này)</h2><p>Nếu bạn nào đã từng biết tới <a href=https://chrome.google.com/webstore/detail/facebook-protector/kadaffcnjkedoajdllakiaobgnmejfmb>Facebook Protector</a> thì <a href="https://chrome.google.com/webstore/detail/j2team-security/hmlcjjclebjnfohgmgikjfnbmfkigocc?utm_source=kipalog">J2TeaM Security</a> chính là phiên bản tiếp theo của nó với nhiều tính năng hơn, khả năng bảo vệ tốt hơn. Bằng việc phân tích theo thời gian thực, J2TeaM Security có thể chặn bất cứ tên miền mới nào mà kẻ tấn công tạo ra nhằm mục đích lừa bạn cài đặt malware.<p>Các bạn có thể đọc bài giới thiệu chi tiết hơn <a href="https://junookyo.blogspot.com/2016/10/j2team-security-chrome-extension.html?utm_source=kipalog">tại đây</a>.<p>Hãy chia sẻ bài viết này với người thân và bạn bè của bạn để giúp họ giữ an toàn trên Facebook nhé!<blockquote>Thực hiện phân tích bởi Juno_okyo và T-Rekt.</blockquote></div></article></div><div id=sidebar_block></div></div><div class=footerEnd><div id=toTop></div><h3>May mắn lớn nhất của cuộc đời, không phải nhặt được tiền, cũng không phải trúng số, mà là có người có thể dẫn bạn đi đến 1 nền tảng cao hơn.</h3></div><script src=../assets/js/jquery.min.js></script><script src=../assets/js/jquery.flatWeatherPlugin.min.js></script><script src=../assets/js/share.js></script><script src=../assets/js/skel.min.js></script><script src=../assets/js/util.js></script><script src=../assets/js/jquery.lazyload.min.js></script><!--[if lte IE 8]><script src=../assets/js/ie/respond.min.js></script><![endif]--><script src=../assets/js/main.js></script><script>function startWeather(){$("#weatherDanang").flatWeatherPlugin({location:"Danang",country:"Vietnam",api:"yahoo",displayCityNameOnly:!1})}</script>
